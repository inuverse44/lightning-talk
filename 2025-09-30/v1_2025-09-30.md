---
marp: true
theme: default
size: 16:9
paginate: true
math: mathjax
header: '待ち行列理論で考えるGKEの最適なポッド数'
footer: 'Inuverse/**エンジニアたちのゆるっと数学勉強会 #10**@2025-09-30, 福岡市天神エンジニアカフェ'

style: |
  /* 三重引用を脚注の記号に転用 */
  /* 下記はdefaultテーマ用。他のテーマで利用するときはbottomとleftを調節してください。 */
  /* スライド全体で利用するため、無名のstyleタグを利用しています。 */
  blockquote > blockquote > blockquote {
    font-size: 50%;
    font-weight: 400;
    padding: 0;
    margin: 0;
    border: 0;
    border-top: 0.1em dashed #555;
    position: absolute;
    bottom: 70px;
    left: 70px;
  }
---

<!-- _class: lead -->

# 待ち行列理論で考えるGKEの最適なポッド数

## Inuverse

**エンジニアたちのゆるっと数学勉強会 #10**
@2025-09-30, 福岡市天神エンジニアカフェ 


---

## 目次

0. 自己紹介
1. 動機と示したいこと
2. 準備
    - GKEとは
    - 待ち行列とは
    - Poisson分布と指数分布
3. 解析
4. 結果
5. 結論と展望

---

## 自己紹介

![bg right:35% 100% fit](assets/inuverse.jpg) 
![bg right:35% 120% fit](assets/qr_inuverse.png) 

- Inuverse（いぬばーす）（=こだま）
  - @mochi_dog_phys
- 2年目
- とある小売企業Tの基幹システムでo11y計装, API開発, 負荷検証
- 物理学、とくに宇宙が好き

---

## 動機と示したいこと
### 動機
- 負荷検証でGKEのポッドにAPIで大量のリクエスト
- Cloud LoggingやCloud Traceで負荷状況を観測
  - 負荷とポッドのリソースはどのような関係だろう。。。
$$ 
  \frac{d R(t)}{dt} 
  \sim  
  (C_{負荷} +  C_{処理能力})R(t)
$$

### 示したいこと
- 負荷と処理能力を軸にして、どれくらいのポッドの数であれば安全？
- SLOを満たすポッド数は？

>>> 1. $C_{負荷}, C_{処理能力}$を厳密に定義しているわけなく、当初の個人的な想像である。例えば負荷が$C_{負荷} = 0$のときを想定すると、明らかに上記の式は破綻する。


---

## 準備
<!-- メモ： 重要な本筋ではないざっと紹介だけする。負荷検証の文脈について、ポッドが水平スケールしてくれることを強調する。-->
### GKEとは
> GKE は、Google が管理する Kubernetes オープンソース コンテナ オーケストレーション プラットフォームです。

[https://cloud.google.com/kubernetes-engine/docs/concepts/kubernetes-engine-overview?hl=ja](https://cloud.google.com/kubernetes-engine/docs/concepts/kubernetes-engine-overview?hl=ja)

### Kubernatesとは
> Kubernetes is a portable, extensible, open source platform for managing containerized workloads and services, that facilitates both declarative configuration and automation. It has a large, rapidly growing ecosystem. Kubernetes services, support, and tools are widely available.
[https://kubernetes.io/docs/concepts/overview/](https://kubernetes.io/docs/concepts/overview/)

--- 

## 準備
### 待ち行列理論 (Queueing theory) とは

- 確率が時間発展し、混雑状況が時事刻々と変化する系を記述するための理論
  - 到着過程 (arrival process)
  - サービス過程 (service process)
- M/M/cモデル
  - 今回採用するモデル
  - 負荷が**ランダム**に到着し、処理の時間も**ランダム**で、それを実行してくれるサーバが$c$個存在する、という意味
  - 到着がランダム$\longrightarrow$ Poissn分布、処理時間がランダム $\longrightarrow$ 指数分布

>>> 1. [A. K. Erlang (1909)](https://www.medicine.mcgill.ca/epidemiology/hanley/statbook/Erlang1909.pdf)


---

## 準備
### Poisson分布と指数分布
<!-- うまく配置できないから、暫定的に表にする -->

<!-- 単位時間の平均リクエスト数を\lambdaとしたとき、単位時間に$k$個のリクエストが来る確率は？？-->

<!-- 単位時間あたりに$\mu$個の処理ができる確率は-->
<!-- 指数分布ってt=0のときどうなるの？-->
|ポアソン分布|指数分布|
|---|---|
|![w:500](https://storage.googleapis.com/zenn-user-upload/b13bb773ce1f-20250709.jpeg)| ![w:500](https://storage.googleapis.com/zenn-user-upload/2aeb1be1fd8b-20250709.jpeg) |


--- 

## 解析
- $P_n(t)$：待ち行列に$n$個のプロセスが残っている確率
- $\lambda$：平均リクエスト数（平均的な負荷を量）
- $\mu_n$：$n$個のプロセスが残っているときの、平均処理時間

$$
	\frac{\mathrm{d} P_n(t)}{\mathrm{d}t}
	= \lambda P_{n-1}(t)
	+ \mu_{n + 1} P_{n+1}(t)
	- (\lambda + \mu_n) P_n(t)
$$

>>> 1. 今回はAPIのリクエストで負荷をかけているという状況を考えているが、一般にこの限りではない。
>>> 2. [https://ia601403.us.archive.org/13/items/in.ernet.dli.2015.134547/2015.134547.Queueing-Systems-Volume-1-Theory.pdf](https://ia601403.us.archive.org/13/items/in.ernet.dli.2015.134547/2015.134547.Queueing-Systems-Volume-1-Theory.pdf)


---
## 解析
- ポッド数を調整するとして、最終的にポッド数は落ち着くはず $\longrightarrow \frac{{\rm d}P_n(t)}{{\rm d} t} = 0$
  - 負荷が高いままならHPAする$\longrightarrow \frac{{\rm d}P_n(t)}{{\rm d} t} \neq 0$

$$
	\underbrace{(\lambda + \mu_n) P_n(t)}_{\tiny{状態nから状態n-1 or n+1への流れ}}
	=
	\underbrace{\lambda P_{n-1}(t)}_{\tiny{状態n-1からnへの流れ}}
	+ \underbrace{\mu_{n + 1} P_{n+1}(t)}_{\tiny{状態n+1からnへの流れ}}
$$

- これが成り立つとき、詳細釣り合いの式
$$	
  \lambda P_{n-1} 
  = \mu_n P_n
$$

$\Longrightarrow$ある程度CPU使用が高い状態を維持しているとき、リクエストの早さと処理の速さが同じ、ということを表しています。

--- 

## 結果

--- 

## 結論と展望

---

## Appendix
